import sqlite3
import os

DB_PATH = os.path.join(os.path.dirname(__file__), 'data', 'mlbb_data.db')

# Карта категорий (Название предмета -> Категория)
ITEM_CATEGORIES = {
    # Атака
    'Клинок отчаяния': 'Атака',
    'Меч охотника на демонов': 'Атака',
    'Коса коррозии': 'Атака',
    'Золотой посох': 'Атака',
    'Ветер природы': 'Атака',
    'Золотой метеор': 'Атака',
    'Топор войны': 'Атака',
    'Топор великана': 'Атака',
    'Удар охотника': 'Атака',
    'Клинок семи морей': 'Атака',
    'Ярость берсерка': 'Атака',
    'Говорящий с ветром': 'Атака',
    'Призрачный коготь': 'Атака',
    'Когти хааса': 'Атака',
    'Бесконечная битва': 'Атака',
    'Громовой пояс': 'Атака', # Иногда относят к защите, но пусть будет тут если надо
    'Злобный рык': 'Атака',
    'Трезубец': 'Атака',
    'Копье великого дракона': 'Атака',
    'Пронзающий небеса': 'Атака',
    'Разбитое сердце': 'Атака', # Малый предмет

    # Магия
    'Божественный меч': 'Магия',
    'Священный кристалл': 'Магия',
    'Палочка гения': 'Магия',
    'Жезл молний': 'Магия',
    'Кровавые крылья': 'Магия',
    'Часы судьбы': 'Магия',
    'Звездная коса': 'Магия',
    'Старлиумовая коса': 'Магия',
    'Жезл снежной королевы': 'Магия',
    'Пылающий жезл': 'Магия',
    'Зимняя корона': 'Магия',
    'Зачарованный талисман': 'Магия',
    'Фонарь желаний': 'Магия',
    'Райское перо': 'Магия',
    'Концентрированная энергия': 'Магия',
    'Мимолетное время': 'Магия',
    'Книга зла': 'Магия',

    # Защита
    'Господство льда': 'Защита',
    'Щит афины': 'Защита',
    'Сияющая броня': 'Защита',
    'Древняя кираса': 'Защита',
    'Шипованная броня': 'Защита',
    'Бессмертие': 'Защита',
    'Кираса грубой силы': 'Защита',
    'Сумеречная броня': 'Защита',
    'Крылья королевы': 'Защита',
    'Штормовой пояс': 'Защита',
    'Проклятый шлем': 'Защита',
    'Защитный шлем': 'Защита',
    'Оракул': 'Защита',
    'Броня неустрашимости': 'Защита',

    # Движение (Сапоги)
    'Ботинки демона': 'Движение',
    'Сапоги скороходы': 'Движение',
    'Магические ботинки': 'Движение',
    'Сапоги спешки': 'Движение',
    'Прочные сапоги': 'Движение',
    'Сапоги воина': 'Движение',
    'Сапоги заклинателя': 'Движение',
    'Ботинки': 'Движение',

    # Роум / Лес (если они есть отдельными предметами)
    'Маска': 'Роум',
    'Кусочек железа': 'Лес',
}

def migrate():
    print(f"Подключение к БД: {DB_PATH}")
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    # 1. Добавляем колонку category, если её нет
    try:
        cursor.execute("ALTER TABLE items ADD COLUMN category TEXT")
        print("Колонка 'category' добавлена.")
    except sqlite3.OperationalError as e:
        if "duplicate column name" in str(e):
            print("Колонка 'category' уже существует.")
        else:
            raise e

    # 2. Обновляем категории
    count = 0
    # Сначала сбрасываем все в 'Прочее'
    cursor.execute("UPDATE items SET category = 'Прочее'")
    
    # Теперь проставляем правильные
    for name, category in ITEM_CATEGORIES.items():
        # Используем LIKE для частичного совпадения (на случай "Золотой Посох" vs "золотой посох")
        cursor.execute("UPDATE items SET category = ? WHERE item_name_ru LIKE ?", (category, name))
        if cursor.rowcount > 0:
            count += cursor.rowcount

    # Дополнительная эвристика для сапог, если они не попали в список
    cursor.execute("UPDATE items SET category = 'Движение' WHERE item_name_ru LIKE '%сапоги%' OR item_name_ru LIKE '%ботинки%'")
    
    conn.commit()
    conn.close()
    print(f"Миграция завершена. Обновлено записей (примерно): {count}")

if __name__ == "__main__":
    migrate()
