# Задачи

- [ ] **Переход на SQLite**
    - [x] Исправить `hero_base_stats.csv`.
    - [x] Создать скрипт `migrate_to_sqlite.py` для переноса данных из CSV в `mlbb_data.db`.
    - [x] Переписать `data_manager.py` для работы с SQLite.
    - [x] Проверить, что сайт работает с новой системой данных.
    - [x] **Проверить и сопоставить все столбцы данных.**
        - [x] Сравнить столбцы из старой и новой структуры данных.
        - [x] Убедиться, что все поля, ожидаемые шаблонами, присутствуют.
        - [x] Установить корректные значения по умолчанию (крит. шанс 0%, крит. урон 200%).
    - [x] **Оптимизировать производительность фронтенда.**
        - [x] Передать все данные о героях в шаблон `hero_base_stats.html`.
        - [x] Переписать `hero_base_stats.js` для работы с локальными данными, убрав API-запросы.
    - [ ] Удалить старые CSV файлы и скрипт миграции.

- [x] **Скрипт для автоматической обработки данных из фандома MLBB (Неудача)**
    - **Парсинг данных со страниц героев (Попытка 4 - Selenium с задержками)**
        - [x] Добавить `selenium` в `requirements.txt`.
        - [x] Установить `geckodriver` (веб-драйвер для Firefox).
        - [x] Переписать `parser_tool.py` для добавления задержек между запросами и обработки данных малыми партиями`.
        - [x] Сохранить данные в `data/csv/heroes_stats.csv`.
    - **Интеграция в приложение**
        - [ ] Модифицировать `data_manager.py` для чтения `heroes_stats.csv`.
        - [ ] Удалить старые, разрозненные CSV файлы.
        - [ ] Обновить `app.py` и шаблоны для работы с новыми данными.

- [ ] **Калькулятор алмазов**

- [ ] **Продвинутый калькулятор урона**

---
# Ход выполнения

**03.09.2025**
- **(Оптимизация)** Для устранения задержек и нагрузки на сервер, фронтенд страницы характеристик был переработан. Все данные о героях теперь загружаются один раз вместе со страницей, а вся фильтрация и расчеты производятся на стороне клиента.
- **(Задача)** Провести полную проверку соответствия столбцов данных между старой и новой структурой.
- **(Исправление)** В `data_manager.py` добавлено сопоставление для `coeff_atk_speed_percent` -> `attack_speed_coefficient_percent` для устранения ошибки в шаблоне.
- **(Исправление)** Установлены значения по умолчанию: шанс крит. удара 0%, крит. урон 200%.
- **(План)** Принято решение перейти с CSV файлов на единую базу данных SQLite (`mlbb_data.db`) для упрощения управления данными.
- **(Уточнение)** По предложению пользователя, решено хранить файл `mlbb_data.db` в репозитории Git для совместимости с бесплатным хостингом Render.com.
- **(Ветка)** Создана новая ветка `feature/sqlite-migration`.
- **(Исправление данных)** Исправлена поврежденная строка в `data/csv/hero_base_stats.csv`.

**02.09.2025**
- Согласован и утвержден план работы. Решено использовать `hero_links.csv` и начать с парсинга.
- **(Неудача)** Первая версия `parser_tool.py` (стандартные библиотеки) не смогла извлечь данные.
- **(Неудача)** Вторая версия `parser_tool.py` (`requests` + `BeautifulSoup`) также не справилась.
- **(Новый план)** Принято решение использовать `Selenium` для управления браузером. Установлен `geckodriver`. 
- **(Неудача)** Третья версия `parser_tool.py` (с `Selenium`) также не смогла извлечь данные. Все запросы завершились неудачей.
- **(Новая гипотеза)** Пользователь предположил, что проблема может быть в ограничении частоты запросов (rate limiting). Решено протестировать эту гипотезу, добавив большие задержки и обработку героев небольшими партиями.
- **(Окончательная неудача)** Тестирование гипотезы о rate-limiting не принесло успеха. Парсинг не удался даже для одного героя с задержкой. Причина блокировки сайта остается неизвестной.
- **(Очистка)** Выполнена очистка проекта: удалены `parser_tool.py`, `debug_parser.py`, `miya.html`, `data/json/heroes_data.json`. Откачены изменения в `requirements.txt`.
- **(Новый подход)** Принято решение отказаться от парсинга Fandom Wiki из-за активной защиты сайта. Вместо этого будет использоваться сторонний API.
- **(Поиск API)** Найден и исследован API `ridwaanhall/api-mobilelegends`. Подтверждена его актуальность (обновлен 17 августа 2025 г.).
- **(Тест API)** Успешно получен список героев и их ID через эндпоинт `hero-rank`.
- **(Новый план сбора данных)** API `ridwaanhall/api-mobilelegends` не предоставляет полного списка героев. Решено:
    - Спарсить имена героев с Liquipedia.
    - Сопоставить имена с ID через API `ridwaanhall/api-mobilelegends`.
    - Собрать полные данные через API.
- **(Неудача API)** Эндпоинт `hero-rank` API не предоставляет полный список героев.
- **(Новый план API)** Решено перебирать `hero_id` от 1 до 150 и запрашивать `hero-detail-stats/{hero_id}` для каждого, чтобы собрать все доступные данные.
- **(Успех API)** Скрипт `api_parser.py` успешно собрал данные для 129 героев из API, создав `heroes_stats.csv`.
- **(Важное уточнение по API)** API `mlbb-stats.ridwaanhall.com` (эндпоинт `hero-detail-stats/{hero_id}`) не предоставляет детальных характеристик героев (таких как физическая атака, магическая защита, HP, мана, скорость передвижения). Он содержит только данные о проценте побед, частоте банов, частоте появления и информацию о синергии с другими героями.
- **(Новый план)** Необходимо найти другой API, который предоставляет именно характеристики героев.
- **(Найден новый API)** Найден подходящий API: `FrenzY8/ML-API` (`https://ml-api-en.vercel.app/api/mlbb?hero=HERO_NAME`). Этот API предоставляет детальные характеристики героев, включая базовые статы (здоровье, атака, защита и т.д.), а также информацию о навыках, лоре и скинах.
- **(Следующие шаги)**
    - Обновить `api_parser.py` для использования `FrenzY8/ML-API`.
    - Использовать `hero_links.csv` для получения списка имен героев для запросов к API.
    - Сохранить извлеченные данные в `data/csv/heroes_stats.csv`, включая базовые характеристики.
- **(Актуальность данных FrenzY8/ML-API)** Проверена актуальность данных API `FrenzY8/ML-API`. API получает данные из Liquipedia, которая обновляется сообществом. Данные считаются достаточно актуальными (не в реальном времени, но оперативно после патчей). Репозиторий API обновлялся 4 месяца назад, что относится к коду API, а не к актуальности данных, которые динамически подтягиваются из Liquipedia.
- **(Решение)** Принято решение продолжить использование API `FrenzY8/ML-API` для сбора данных о характеристиках героев.
- **(Успешный сбор данных)** Скрипт `api_parser.py` успешно собрал данные для 129 героев из `FrenzY8/ML-API` и сохранил их в `data/csv/heroes_stats.csv`.
- **(Частичная неудача)** При сборе данных для героя 'Obsidia' произошла ошибка (500 Server Error) со стороны API, данные для этого героя не были получены.
- **(Критические отсутствующие данные)** Пользователь подтвердил, что данные о характеристиках на 15 уровне, дальности атаки, шансе критического удара, сложности, эффекте навыков, прочности и атаке являются критически важными для сайта. Текущий API `FrenzY8/ML-API` не предоставляет эти данные в полном объеме.
- **(Несовместимость DataManager)** Выявлена несовместимость `data_manager.py` с текущими и планируемыми файлами данных. `data_manager.py` ожидает более полную структуру данных (включая параметры роста и детальные боевые атрибуты), чем та, что доступна из API или будет вноситься вручную.
- **(Приоритет ручного обновления)** Принято решение сначала полностью обновить файл `/home/wayer/Projects/MLBB_Helper_website/data/csv/харатеристики персов MLBB.csv` вручную, прежде чем приступать к модификации `data_manager.py` и `test_csv_data.py`.
- **(Необходимость переоценки API)** Требуется повторно оценить возможности `FrenzY8/ML-API` и, возможно, найти новый источник данных, который предоставляет все необходимые характеристики.
- **(Окончательный вывод по API)** После исчерпывающего поиска не удалось найти полноценный API или дамп данных, который предоставлял бы все необходимые детальные характеристики героев (включая статы на 15 уровне, дальность атаки, шанс крит. удара, сложность, прочность, атаку, эффект навыков).
- **(Принятое решение)** Принято решение отказаться от использования сторонних API для получения характеристик героев. Вместо этого, недостающие и актуальные данные будут вноситься вручную в существующий файл `/home/wayer/Projects/MLBB_Helper_website/data/csv/харатеристики персов MLBB.csv`.
- **(Расхождения в данных)** Обнаружено расхождение: `hero_links.csv` содержит 130 героев, а `heroes_stats.csv` — 129. Необходимо сравнить списки для выявления отсутствующих/новых героев.